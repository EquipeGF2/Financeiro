-- 1) Garante o schema
create schema if not exists financas;

-- 2) Move tabelas-alvo do public -> financas, se existirem
do $$
declare
  r record;
  alvo constant text[] := array[
    'categorias',
    'movimentacoes',
    'usuarios',       -- ajuste se seu nome for diferente
    'contas',         -- adicione/remova conforme seu projeto
    'carteiras',
    'lancamentos'
  ];
begin
  for r in
    select c.relname as tabela
    from pg_class c
    join pg_namespace n on n.oid = c.relnamespace
    where n.nspname = 'public'
      and c.relkind = 'r'
      and c.relname = any (alvo)
  loop
    execute format('alter table public.%I set schema financas;', r.tabela);
  end loop;
end $$;

-- 3) Move sequências que ficaram no public mas pertencem às tabelas já movidas
do $$
declare
  r record;
begin
  for r in
    select s.relname as seqname
    from pg_class s
    join pg_namespace ns on ns.oid = s.relnamespace
    join pg_depend d on d.objid = s.oid and d.deptype = 'a'
    join pg_class t on t.oid = d.refobjid
    join pg_namespace nt on nt.oid = t.relnamespace
    where s.relkind = 'S'
      and ns.nspname = 'public'
      and nt.nspname = 'financas'
  loop
    execute format('alter sequence public.%I set schema financas;', r.seqname);
  end loop;
end $$;

-- 4) Grants mínimos (RLS continuará controlando acesso nas tabelas)
grant usage on schema financas to anon, authenticated;
